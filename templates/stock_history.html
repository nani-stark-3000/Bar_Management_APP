{% extends 'base.html' %}
{% block title %}Stock History{% endblock %}
{% block content %}
<h2 class="text-center mb-4">Stock History</h2>

<div id="filters" class="row mb-4">
    <div class="col-md-4">
        <label for="search-input" class="form-label">Search Product (Name or Code)</label>
        <input type="text" id="search-input" class="form-control" placeholder="Type to search..." oninput="liveSearch()">
    </div>
    <div class="col-md-4">
        <label for="date-filter" class="form-label">Filter by Date</label>
        <input type="date" id="date-filter" class="form-control" onchange="applyFilters()">
    </div>
</div>

<!-- Stock History Cards -->
<div id="stock-history" class="container-fluid">
    <div class="row">
        {% for history in stock_history %}
        <div class="col-12 mb-4">
            <div class="card p-3 shadow-sm" style="width: 100%;" data-date="{{ history.date_added.split(' ')[0] }}">
                <!-- Product Details -->
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h5 class="card-title">{{ history.brand_name }} {{ history.brand_type }} {{ history.brand_size }}ml</h5>
                        <p class="card-text">
                            <strong>Brand Code:</strong> {{ history.brand_code }}<br>
                            <strong>Barcode:</strong> {{ history.barcode }}
                        </p>
                    </div>
                    <div class="col-md-3 text-center">
                        <p class="card-text mb-1">
                            <strong>Invoice Rate:</strong> ₹{{ history.invoice_rate }}<br>
                            <strong>MRP:</strong> ₹{{ history.mrp }}<br>
                            <strong>Quantity Added:</strong> {{ history.quantity }}
                        </p>
                    </div>
                    <div class="col-md-3 text-center">
                        <p class="card-text mb-1">
                            <strong>Date:</strong> {{ history.date_added.split(' ')[0] }}<br>
                            <strong>Time:</strong> {{ history.date_added.split(' ')[1] }}
                        </p>
                    </div>
                    <div class="col-md-2 text-end">
                        <p class="card-text">
                            <strong>Added By:</strong> {{ history.added_by }}
                        </p>
                        <button class="btn btn-danger btn-sm" onclick="revokeStock({{ history.product_id }}, {{ history.id }})">
                            <i class="fas fa-undo"></i> Revoke
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Live Search Functionality
    function liveSearch() {
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const historyCards = document.querySelectorAll('.card');

        historyCards.forEach(card => {
            const name = card.querySelector('.card-title').textContent.toLowerCase();
            const code = card.querySelector('.card-text').textContent.toLowerCase();
            if (name.includes(searchInput) || code.includes(searchInput)) {
                card.parentElement.style.display = 'block';
            } else {
                card.parentElement.style.display = 'none';
            }
        });
    }

    // Apply Filters Functionality
    function applyFilters() {
        const dateFilter = document.getElementById('date-filter').value;
        const historyCards = document.querySelectorAll('.card');

        historyCards.forEach(card => {
            const dateAdded = card.getAttribute('data-date');
            const matchesDate = !dateFilter || dateAdded === dateFilter;

            if (matchesDate) {
                card.style.display = 'flex'; // Show matching cards
            } else {
                card.style.display = 'none'; // Hide non-matching cards
            }
        });
    }

    // Revoke Stock Functionality
    function revokeStock(productId, historyId) {
        if (confirm("Are you sure you want to revoke this stock addition?")) {
            fetch(`/admin/revoke-stock`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ product_id: productId, history_id: historyId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.error || 'Failed to revoke stock addition.');
                }
            });
        }
    }
</script>
{% endblock %}
