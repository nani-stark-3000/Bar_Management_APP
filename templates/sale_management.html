{% extends 'base.html' %}
{% block title %}Sale Management{% endblock %}
{% block content %}
<h2 class="text-center mb-4">Sale Management</h2>

<!-- Add Product Section -->
<div class="mb-4">
    <input type="text" id="barcode-input" class="form-control mb-2" placeholder="Scan Barcode">
    <input type="text" id="search-input" class="form-control" placeholder="Search by Name or Brand Code" oninput="searchProduct()">
    <ul id="search-results" class="list-group mt-2" style="display: none;"></ul>
</div>

<!-- Date Selection for Admin -->
{% if session['role'] == 'Admin' %}
<div class="mb-4">
    <label for="sale-date" class="form-label">Select Date:</label>
    <input type="date" id="sale-date" class="form-control w-auto" value="{{ today.strftime('%Y-%m-%d') }}">
</div>
{% endif %}

<!-- Sale Items Table -->
<div class="table-responsive">
    <table class="table table-bordered text-center" id="sale-items-table">
        <thead class="thead-light">
            <tr>
                <th style="font-size: larger;">Item Name</th>
                <th style="font-size: larger;">Selling Price (₹)</th>
                <th style="font-size: larger;">Quantity</th>
                <th style="font-size: larger;">Total (₹)</th>
                <th style="font-size: larger;">Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Sale items will be dynamically added here -->
        </tbody>
    </table>
</div>

<!-- Grand Total -->
<div class="text-end mt-3">
    <strong style="font-size: larger;">Grand Total: ₹<span id="grand-total">0.00</span></strong>
</div>

<!-- Confirm or Reject Sale -->
<div class="mt-3 text-center">
    <button class="btn btn-success btn-lg me-2" onclick="confirmSale()">Confirm Sale</button>
    <button class="btn btn-danger btn-lg" onclick="rejectSale()">Reject Sale</button>
</div>

<script>
    const allProducts = {{ products | tojson | safe }};
    const barcodeInput = document.getElementById("barcode-input");
    const saleDateInput = document.getElementById("sale-date");

    // Ensure the barcode input is focused
    function focusBarcodeInput() {
        barcodeInput.focus();
    }

    // Add product to the sale list by barcode input
    barcodeInput.addEventListener("input", function () {
        const barcode = this.value.trim();
        const product = allProducts.find(p => p.barcode === barcode);
        if (product) {
            addProductToSale(product.id, 1);
            this.value = ""; // Clear the input after adding product
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Focus the barcode input by default
        focusBarcodeInput();

        // Bind the Enter key to confirm sale
        document.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                const barcodeInput = document.getElementById("barcode-input");
                if (document.activeElement === barcodeInput && barcodeInput.value.trim() !== "") {
                    const barcode = barcodeInput.value.trim();
                    const product = allProducts.find(p => p.barcode === barcode);
                    if (product) {
                        addProductToSale(product.id, 1);
                    }
                    barcodeInput.value = "";
                    return; // Prevent the sale confirmation if Enter is pressed in barcode input
                }

                confirmSale(); // Confirm sale if Enter is pressed elsewhere
                event.preventDefault();
            }
        });
    });

    // Search products by name or brand code
    function searchProduct() {
        const query = document.getElementById("search-input").value.toLowerCase();
        const searchResults = document.getElementById("search-results");
        searchResults.innerHTML = "";

        const filteredProducts = allProducts.filter(
            product =>
                product.brand_name.toLowerCase().includes(query) ||
                product.brand_code.toLowerCase().includes(query)
        );

        if (filteredProducts.length > 0) {
            searchResults.style.display = "block";

            filteredProducts.forEach(product => {
                const listItem = document.createElement("li");
                listItem.className = "list-group-item";
                listItem.textContent = `${product.brand_name} (${product.brand_type} - ${product.brand_size}ml)`;
                listItem.onclick = () => {
                    addProductToSale(product.id, 1);
                    searchResults.style.display = "none";
                };
                searchResults.appendChild(listItem);
            });
        } else {
            searchResults.style.display = "none";
        }
    }

    function addProductToSale(productId, quantity = 1) {
        fetch("/sales/add-product", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ product_id: productId, quantity }),
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    updateSaleList(data.sale_list);
                    focusBarcodeInput();
                }
            })
            .catch(err => console.error("Error adding product to sale:", err));
    }

    function updateQuantity(productKey, newQuantity) {
        fetch("/sales/update-quantity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sale_item_key: productKey, quantity: newQuantity }),
        })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    updateSaleList(data.sale_list);
                } else {
                    alert(data.error || "Failed to update quantity.");
                }
            });
    }

    function removeProduct(productKey) {
        fetch("/sales/remove-product", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sale_item_key: productKey }),
        })
            .then(res => res.json())
            .then(data => {
                updateSaleList(data.sale_list);
                focusBarcodeInput();
            })
            .catch(err => console.error("Error removing product:", err));
    }

    function updateSaleList(saleList) {
        const tableBody = document.querySelector("#sale-items-table tbody");
        const grandTotalElement = document.getElementById("grand-total");

        let grandTotal = 0;
        tableBody.innerHTML = "";

        for (const [key, item] of Object.entries(saleList)) {
            const total = item.selling_price * item.quantity;
            grandTotal += total;

            const row = `
                <tr>
                    <td>${item.brand_name} ${item.brand_type} ${item.brand_size}ml</td>
                    <td>₹${item.selling_price.toFixed(2)}</td>
                    <td>
                        {% if session['role'] == 'Admin' %}
                        <input type="number" value="${item.quantity}" class="form-control quantity-input" onchange="updateQuantity('${key}', this.value)">
                        {% else %}
                        ${item.quantity}
                        {% endif %}
                    </td>
                    <td>₹${total.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeProduct('${key}')">Remove</button>
                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML("beforeend", row);
        }

        grandTotalElement.textContent = grandTotal.toFixed(2);
    }

    function confirmSale() {
        const selectedDate = saleDateInput ? saleDateInput.value : null; // Get the selected date (if admin)

        fetch("/sales/confirm-sale", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sale_date: selectedDate }),
        })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    document.querySelector("#sale-items-table tbody").innerHTML = "";
                    document.getElementById("grand-total").textContent = "0.00";
                    focusBarcodeInput();
                }
            })
            .catch(err => console.error("Error confirming sale:", err));
    }

    function rejectSale() {
        fetch("/sales/reject-sale", { method: "POST" })
            .then(() => {
                document.querySelector("#sale-items-table tbody").innerHTML = "";
                document.getElementById("grand-total").textContent = "0.00";
                focusBarcodeInput();
            })
            .catch(err => console.error("Error rejecting sale:", err));
    }

    document.addEventListener("DOMContentLoaded", focusBarcodeInput);
</script>
{% endblock %}
